<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>大模型检测 | NextGen EduTech</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  </head>
  <body>
    <nav class="sidebar">
      <div class="logo">大模型检测系统</div>
      <ul class="nav-menu">
        <li class="nav-item" data-page="home">
          <i class="fas fa-home"></i> 系统首页
        </li>
        <li class="nav-item" data-page="question-generate">
          <i class="fas fa-database"></i> 题库生成
        </li>
        <li class="nav-item" data-page="question-transform">
          <i class="fas fa-shapes"></i> 题库变形
        </li>
        <li class="nav-item" data-page="data-audit">
          <i class="fas fa-check-double"></i> 数据审核
        </li>
        <li class="nav-item" data-page="result-generate">
          <i class="fas fa-chart-bar"></i> 结果分析
        </li>
      </ul>
    </nav>

    <main class="main-content">
      <!-- 首页 -->
      <div class="content-card content-page active" id="home">
        <h1 class="hero-title">大模型智能检测系统</h1>
        <!-- 优势模块 -->
        <div class="advantages-grid">
          <div class="advantage-card">
            <div class="advantage-icon"><i class="fas fa-brain"></i></div>
            <h3 class="advantage-title">多模态检测</h3>
            <p class="advantage-desc">
              支持文本、代码、数学公式等多模态内容检测，覆盖20+种AI模型特征
            </p>
          </div>

          <div class="advantage-card">
            <div class="advantage-icon"><i class="fas fa-shield-alt"></i></div>
            <h3 class="advantage-title">安全可靠</h3>
            <p class="advantage-desc">
              采用军事级加密传输，通过ISO 27001认证，保障数据隐私与安全
            </p>
          </div>

          <div class="advantage-card">
            <div class="advantage-icon"><i class="fas fa-bolt"></i></div>
            <h3 class="advantage-title">极速响应</h3>
            <p class="advantage-desc">
              分布式计算架构支持，平均检测响应时间小于800ms，支持百万级并发
            </p>
          </div>
          <div class="advantage-card">
            <div class="advantage-icon"><i class="fas fa-chart-line"></i></div>
            <h3 class="advantage-title">智能分析</h3>
            <p class="advantage-desc">
              实时数据可视化与深度分析，提供多维度的检测报告和可执行建议
            </p>
          </div>
          <div class="advantage-card">
            <div class="advantage-icon"><i class="fas fa-globe"></i></div>
            <h3 class="advantage-title">多语言支持</h3>
            <p class="advantage-desc">
              支持中英日韩等12种语言混合检测，精准识别跨语言AI生成内容
            </p>
          </div>

          <div class="advantage-card">
            <div class="advantage-icon"><i class="fas fa-sync-alt"></i></div>
            <h3 class="advantage-title">实时更新</h3>
            <p class="advantage-desc">
              动态追踪200+个AI模型演进，特征库每小时自动更新保障检测时效性
            </p>
          </div>
        </div>
        <div class="tech-specs">
          <div class="spec-item">
            <div class="spec-value">98.7%</div>
            <div class="spec-label">检测准确率</div>
          </div>
          <div class="spec-item">
            <div class="spec-value">50ms</div>
            <div class="spec-label">单题检测时延</div>
          </div>
          <div class="spec-item">
            <div class="spec-value">1.2B</div>
            <div class="spec-label">特征库规模</div>
          </div>
          <div class="spec-item">
            <div class="spec-value">200+</div>
            <div class="spec-label">支持语言</div>
          </div>
        </div>

        <!-- 缩小技术面板 -->
        <div
          class="content-card"
          style="
            background: var(--gradient-primary);
            color: white;
            padding: 1.5rem;
            margin: 1rem 0;
          "
        >
          <div class="columns-container" style="gap: 1.5rem">
            <div style="flex: 1">
              <h2 style="color: white; font-size: 1.2rem">技术优势</h2>
              <div
                class="metric-card"
                style="background: rgba(255, 255, 255, 0.15); padding: 1rem"
              >
                <div class="metric-value" style="font-size: 2rem">98%</div>
                <div class="metric-label" style="font-size: 0.9rem">
                  检测准确率
                </div>
              </div>
            </div>

            <div style="flex: 1.5">
              <h2 style="color: white; font-size: 1.2rem">操作流程</h2>
              <div class="progress-bar" style="height: 4px; margin: 1.5rem 0">
                <div class="progress-fill" style="width: 100%"></div>
              </div>
              <div
                class="columns-container"
                style="color: white; font-size: 0.9rem; gap: 0.8rem"
              >
                <div>1. 输入数据</div>
                <i class="fas fa-arrow-right"></i>
                <div>2. 智能处理</div>
                <i class="fas fa-arrow-right"></i>
                <div>3. 结果分析</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 强化跳转按钮 -->
        <div
          class="content-card"
          style="
            text-align: center;
            padding: 1.5rem;
            margin-top: 1rem;
            position: relative;
          "
        >
          <button
            class="submit-btn pulse-animation"
            onclick="handleNavigation('question-generate')"
            style="padding: 1rem 3rem; font-size: 1.1rem; margin: 1rem auto"
          >
            <i class="fas fa-rocket"></i> 立即开始使用
          </button>
          <p style="opacity: 0.8; font-size: 0.9rem">
            支持格式：TXT/DOCX/PDF/Markdown
          </p>
          <div class="scroll-indicator">
            <i class="fas fa-angle-double-down fa-lg"></i>
          </div>
        </div>
      </div>
      <!-- 题库生成部分 -->
      <div class="content-card content-page" id="question-generate">
        <h1>题库生成</h1>

        <div class="columns-container">
          <div>
            <h3>题目类型</h3>
            <div class="radio-group">
              <label
                ><input
                  type="radio"
                  name="qtype"
                  value="multiple_choice"
                  checked
                />
                选择题</label
              >
              <label
                ><input type="radio" name="qtype" value="true_false" />
                判断题</label
              >
              <label
                ><input type="radio" name="qtype" value="short_answer" />
                简答题</label
              >
              <label
                ><input type="radio" name="qtype" value="fill_blank" />
                填空题</label
              >
            </div>
          </div>
          <div>
            <h3>题目数量</h3>
            <input type="number" id="qcount" min="500" max="1000" value="500" />
          </div>
        </div>

        <div class="columns-container">
          <div>
            <h3>题目难度</h3>
            <select id="qdifficulty">
              <option value="easy">简单</option>
              <option value="medium" selected>中等</option>
              <option value="hard">困难</option>
            </select>
          </div>
          <div>
            <h3>题目主题</h3>
            <div class="tag-mode-selector">
              <label
                ><input type="radio" name="tag-mode" value="preset" checked />
                预设主题</label
              >
              <label
                ><input type="radio" name="tag-mode" value="custom" />
                自定义主题</label
              >
            </div>

            <select id="qtopic" class="tag-input">
              <option value="">全部主题</option>
              <option value="计算机科学">计算机科学</option>
              <option value="人工智能">人工智能</option>
              <option value="数据科学">数据科学</option>
            </select>

            <input
              type="text"
              id="custom-topic"
              class="tag-input"
              style="display: none"
              placeholder="输入自定义主题(如:机器学习、网络安全等)"
            />
          </div>
        </div>

        <div class="columns-container">
          <div>
            <h3>题目来源模型</h3>
            <div id="model-btn-group">
              <button class="model-btn active" data-model="deepseek">
                DeepSeek
              </button>
              <button class="model-btn" data-model="model2">模型2</button>
              <button class="model-btn" data-model="model3">模型3</button>
              <button class="model-btn" data-model="model4">模型4</button>
              <button class="model-btn" data-model="model5">模型5</button>
            </div>
            <input type="hidden" id="qmodel" value="deepseek" />
          </div>
        </div>

        <button id="generateBtn" class="submit-btn">
          <i class="fas fa-play"></i> 开始生成题目
        </button>

        <div id="question-results" style="margin-top: 2rem">
          <h3>生成结果</h3>
          <div class="progress-bar">
            <div
              id="generate-progress"
              class="progress-fill"
              style="width: 0%"
            ></div>
          </div>

          <div
            id="questions-container"
            class="example-container"
            style="margin-top: 1.5rem"
          >
            <!-- 动态生成的题目将显示在这里 -->
          </div>

          <div id="view-all-container">
            <button
              id="viewAllBtn"
              class="submit-btn"
              style="padding: 0.75rem 1.5rem"
            >
              <i class="fas fa-list"></i> 查看全部题目
            </button>
            <p id="total-count"></p>
          </div>
        </div>
      </div>

      <script>
        function selectModel(model) {
          document.getElementById('qmodel').value = model
          document.querySelectorAll('#model-buttons button').forEach((btn) => {
            btn.classList.remove('pulse-animation')
          })
          const selectedBtn = Array.from(
            document.querySelectorAll('#model-buttons button')
          ).find(
            (btn) =>
              btn.textContent.includes(model.replace('model', '模型')) ||
              btn.textContent.toLowerCase().includes(model)
          )
          if (selectedBtn) selectedBtn.classList.add('pulse-animation')
        }
      </script>

      <!-- 题库变形 -->
      <div class="content-card content-page" id="question-transform">
        <h1>题库变形</h1>

        <div class="transform-controls">
          <div class="transform-types">
            <h3>选择变形方式</h3>
            <div class="transform-buttons">
              <button class="transform-btn active" data-type="paraphrase">
                <i class="fas fa-exchange-alt"></i> 同义替换
              </button>
              <button class="transform-btn" data-type="restructure">
                <i class="fas fa-project-diagram"></i> 结构调整
              </button>
              <button class="transform-btn" data-type="difficulty">
                <i class="fas fa-signal"></i> 难度调整
              </button>
              <button class="transform-btn" data-type="format">
                <i class="fas fa-file-alt"></i> 格式转换
              </button>
              <button class="transform-btn" data-type="translate">
                <i class="fas fa-language"></i> 语言翻译
              </button>
            </div>
          </div>

          <div class="transform-params" id="transform-params">
            <!-- 动态参数区域 -->
          </div>

          <button id="execute-transform" class="submit-btn">
            <i class="fas fa-magic"></i> 执行变形
          </button>
        </div>

        <div class="transform-results">
          <h3>变形结果</h3>
          <div id="results-container" class="results-grid"></div>
        </div>
      </div>

      <!-- 数据审核模块 -->
      <div class="content-card content-page" id="data-audit">
        <h1>数据审核</h1>

        <div class="columns-container">
          <div>
            <h3>审核模式</h3>
            <div class="btn-group-grid">
              <button class="form-btn active" data-mode="basic">
                基础模式
              </button>
              <button class="form-btn" data-mode="full">完整模式</button>
              <button class="form-btn" data-mode="performance">性能模式</button>
            </div>
          </div>
        </div>

        <button id="runAuditBtn" class="submit-btn">
          <i class="fas fa-search"></i> 开始审核
        </button>

        <div
          id="audit-summary"
          class="columns-container"
          style="margin-top: 2rem; display: none"
        >
          <!-- 审核指标将在这里动态填充 -->
        </div>

        <div id="risk-table-section" style="margin-top: 2rem; display: none">
          <h3>风险问题列表</h3>
          <table class="history-table">
            <thead>
              <tr>
                <th>问题内容</th>
                <th>风险分类</th>
                <th>说明</th>
                <th>等级</th>
              </tr>
            </thead>
            <tbody id="risk-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- 结果分析 -->
      <div class="content-card content-page" id="result-generate">
        <h1>结果分析</h1>
        <div class="metric-grid">
          <div class="metric-card">
            <div class="metric-value" id="final-score">--</div>
            <div class="metric-label">综合评分</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="final-success">--</div>
            <div class="metric-label">安全通过率</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="final-cpu">--</div>
            <div class="metric-label">CPU峰值</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="final-memory">--</div>
            <div class="metric-label">内存峰值</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="final-response">--</div>
            <div class="metric-label">平均响应</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="final-qps">--</div>
            <div class="metric-label">QPS</div>
          </div>
        </div>
        <div class="report-section">
          <button class="submit-btn" id="loadReportBtn">
            <i class="fas fa-sync-alt"></i> 加载分析报告
          </button>
          <div id="reportLinks" style="display: none; margin-top: 1rem">
            <a
              href="#"
              id="downloadMdBtn"
              class="submit-btn"
              style="margin-right: 0.5rem"
            >
              <i class="fas fa-download"></i> 下载 Markdown 报告
            </a>
            <a href="#" id="downloadJsonBtn" class="submit-btn">
              <i class="fas fa-download"></i> 下载 JSON 报告
            </a>
          </div>
        </div>
      </div>
    </main>

    <script>
      // 全局导航处理函数
      function handleNavigation(targetPage) {
        window.setActivePage(targetPage)
        history.pushState({}, '', `#${targetPage}`)
      }

      // 全局页面切换函数
      window.setActivePage = function (pageId) {
        const pages = document.querySelectorAll('.content-page')
        const navItems = document.querySelectorAll('.nav-item')

        // GSAP页面切换动画
        pages.forEach((page) => {
          if (page.id === pageId) {
            gsap.fromTo(
              page,
              { opacity: 0, y: 20, display: 'none' },
              {
                duration: 0.6,
                opacity: 1,
                y: 0,
                display: 'block',
                ease: 'power3.out',
                onComplete: () => {
                  // 重新绑定动态内容的事件
                  bindNavEvents()
                },
              }
            )
          } else {
            gsap.to(page, {
              duration: 0.3,
              opacity: 0,
              y: 20,
              ease: 'power2.inOut',
              onComplete: () => (page.style.display = 'none'),
            })
          }
        })

        // 更新导航状态
        navItems.forEach((nav) => {
          nav.classList.toggle('active', nav.dataset.page === pageId)
        })

        // 滚动到顶部
        window.scrollTo({ top: 0, behavior: 'smooth' })
      }

      // 事件绑定函数
      function bindNavEvents() {
        document.querySelectorAll('.nav-item').forEach((item) => {
          // 移除旧的事件监听器
          item.removeEventListener('click', handleNavClick)
          // 添加新的事件监听器
          item.addEventListener('click', handleNavClick)
        })

        // 绑定标签模式切换事件
        document.querySelectorAll('input[name="tag-mode"]').forEach((radio) => {
          radio.removeEventListener('change', handleTagModeChange)
          radio.addEventListener('change', handleTagModeChange)
        })

        // 绑定生成按钮事件
        const generateBtn = document.getElementById('generateBtn')
        if (generateBtn) {
          generateBtn.removeEventListener('click', handleGenerateQuestions)
          generateBtn.addEventListener('click', handleGenerateQuestions)
        }

        // 绑定查看全部按钮事件
        const viewAllBtn = document.getElementById('viewAllBtn')
        if (viewAllBtn) {
          viewAllBtn.removeEventListener('click', handleViewAllQuestions)
          viewAllBtn.addEventListener('click', handleViewAllQuestions)
        }
      }

      // 标签模式切换处理
      function handleTagModeChange() {
        const isCustom = this.value === 'custom'
        document.getElementById('qtopic').style.display = isCustom
          ? 'none'
          : 'block'
        document.getElementById('custom-topic-container').style.display =
          isCustom ? 'block' : 'none'
      }

      // 导航点击处理
      function handleNavClick(e) {
        e.preventDefault()
        const targetPage = this.dataset.page
        handleNavigation(targetPage)
      }

      // 题库生成功能
      async function handleGenerateQuestions() {
        const btn = this
        const progress = document.getElementById('generate-progress')
        const container = document.getElementById('questions-container')
        const viewAllContainer = document.getElementById('view-all-container')
        const totalCountEl = document.getElementById('total-count')

        // 重置状态
        btn.disabled = true
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...'
        progress.style.width = '0%'
        container.innerHTML =
          '<div class="example-card"><p>正在生成题目，请稍候...</p></div>'
        viewAllContainer.style.display = 'none'

        try {
          // ==================== 1. 收集用户输入 ====================
          const selectedTypes = Array.from(
            document.querySelectorAll('input[name="qtype"]:checked')
          ).map((el) => el.value)
          const count = parseInt(document.getElementById('qcount').value)
          const difficulty = document.getElementById('qdifficulty').value
          const model = document.getElementById('qmodel').value

          // 获取主题（预设或自定义）
          const isCustomTopic =
            document.querySelector('input[name="tag-mode"]:checked').value ===
            'custom'
          let topic = ''
          if (isCustomTopic) {
            topic = document.getElementById('custom-topic').value.trim()
            if (!topic) {
              throw new Error('请输入自定义主题')
            }
          } else {
            topic = document.getElementById('qtopic').value
          }

          // 验证输入
          if (selectedTypes.length === 0) {
            throw new Error('请至少选择一种题目类型')
          }
          if (isNaN(count) || count < 5) {
            throw new Error('题目数量需大于5')
          }

          // ==================== 2. 准备请求数据 ====================
          const requestData = {
            types: selectedTypes,
            count: count,
            difficulty: difficulty,
            topic: topic,
            is_custom_topic: isCustomTopic,
            model: model,
          }

          console.log('[DEBUG] 发送请求数据:', requestData)

          // ==================== 3. 显示进度条动画 ====================
          const progressInterval = setInterval(() => {
            const current = parseInt(progress.style.width) || 0
            const increment = current < 90 ? 10 : 0 // 到达90%后停止自动增长
            progress.style.width = current + increment + '%'
          }, 300)

          // ==================== 4. 调用API ====================
          let response
          try {
            response = await fetch('http://localhost:8000/generate', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(requestData),
              mode: 'cors',
            })
          } catch (networkError) {
            clearInterval(progressInterval)
            throw new Error(`网络连接失败: ${networkError.message}`)
          }

          clearInterval(progressInterval)
          progress.style.width = '100%'

          // ==================== 5. 处理响应 ====================
          if (!response.ok) {
            // 尝试解析错误信息
            let errorMsg = `请求失败: ${response.status}`
            try {
              const errorData = await response.json()
              errorMsg = errorData.message || errorMsg
            } catch (e) {}
            throw new Error(errorMsg)
          }

          const data = await response.json()
          console.log('[DEBUG] 收到响应数据:', data)

          // ==================== 6. 显示结果 ====================
          if (
            data.status === 'success' &&
            data.questions &&
            data.questions.length > 0
          ) {
            // 存储全部题目
            window.allQuestions = data.questions

            // 只显示前3个题目（如果多于3个）
            const displayCount = Math.min(3, data.questions.length)
            const displayQuestions = data.questions.slice(0, displayCount)
            container.innerHTML = renderQuestions(displayQuestions)

            // 如果题目多于3个，显示"查看全部"按钮
            if (data.questions.length > 3) {
              viewAllContainer.style.display = 'block'
              totalCountEl.textContent = `共生成 ${data.questions.length} 道题目`
            }

            // 自动滚动到结果区域
            container.scrollIntoView({ behavior: 'smooth' })
          } else {
            throw new Error(data.message || '没有生成题目，请检查参数设置')
          }
        } catch (error) {
          console.error('[ERROR] 生成题目出错:', error)

          // 显示友好的错误信息
          container.innerHTML = `
        <div class="example-card" style="color: #ef4444;">
            <p><i class="fas fa-exclamation-triangle"></i> ${error.message}</p>
            ${
              error.message.includes('网络连接')
                ? '<p style="font-size:0.8rem">请检查后端服务是否运行 (http://localhost:8000)</p>'
                : ''
            }
        </div>`

          // 重置进度条
          progress.style.width = '0%'
        } finally {
          btn.disabled = false
          btn.innerHTML = '<i class="fas fa-play"></i> 重新生成'
        }
      }

      // 辅助函数：渲染题目列表
      function renderQuestions(questions) {
        return questions
          .map((q, i) => {
            let typeClass = '',
              typeText = ''
            switch (q.type) {
              case 'multiple_choice':
                typeClass = 'multiple-choice'
                typeText = '选择题'
                break
              case 'true_false':
                typeClass = 'true-false'
                typeText = '判断题'
                break
              case 'short_answer':
                typeClass = 'short-answer'
                typeText = '简答题'
                break
              case 'fill_blank':
                typeClass = 'fill-blank'
                typeText = '填空题'
                break
              default:
                typeText = q.type || '未知类型'
            }

            return `
        <div class="example-card">
            <div class="example-header">
                <span class="question-type ${typeClass}">${typeText}</span>
                ${
                  q.difficulty
                    ? `<span class="question-difficulty">${q.difficulty}</span>`
                    : ''
                }
                ${
                  q.topic
                    ? `<span class="question-topic">${q.topic}</span>`
                    : ''
                }
            </div>
            <p class="question-content">${i + 1}. ${q.question}</p>
            ${
              q.options
                ? `
            <div class="question-options">
                ${Object.entries(q.options)
                  .map(([key, val]) => `<p>${key}. ${val}</p>`)
                  .join('')}
            </div>`
                : ''
            }
            ${
              q.answer ? `<p class="question-answer">答案: ${q.answer}</p>` : ''
            }
            ${
              q.explanation
                ? `<p class="question-explanation">解析: ${q.explanation}</p>`
                : ''
            }
        </div>`
          })
          .join('')
      }
      // 查看全部题目
      function handleViewAllQuestions() {
        const container = document.getElementById('questions-container')
        if (window.allQuestions) {
          container.innerHTML = renderQuestions(window.allQuestions)
          document.getElementById('view-all-container').style.display = 'none'
        }
      }

      // 渲染题目列表的函数
      function renderQuestions(questions) {
        return questions
          .map((q, i) => {
            let typeClass = '',
              typeText = ''
            switch (q.type) {
              case 'multiple_choice':
                typeClass = 'multiple-choice'
                typeText = '选择题'
                break
              case 'true_false':
                typeClass = 'true-false'
                typeText = '判断题'
                break
              case 'short_answer':
                typeClass = 'short-answer'
                typeText = '简答题'
                break
              case 'fill_blank':
                typeClass = 'fill-blank'
                typeText = '填空题'
                break
              default:
                typeText = q.type || '未知类型'
            }

            return `
        <div class="example-card">
            <div class="example-header">
                <span class="question-type ${typeClass}">${typeText}</span>
                ${
                  q.difficulty
                    ? `<span class="question-difficulty">${q.difficulty}</span>`
                    : ''
                }
                ${
                  q.topic
                    ? `<span class="question-topic">${q.topic}</span>`
                    : ''
                }
            </div>
            <p class="question-content">${i + 1}. ${q.question}</p>
            ${
              q.options
                ? `
            <div class="question-options">
                ${Object.entries(q.options)
                  .map(([key, val]) => `<p>${key}. ${val}</p>`)
                  .join('')}
            </div>`
                : ''
            }
            ${
              q.answer ? `<p class="question-answer">答案: ${q.answer}</p>` : ''
            }
            ${
              q.explanation
                ? `<p class="question-explanation">解析: ${q.explanation}</p>`
                : ''
            }
        </div>`
          })
          .join('')
      }

      // 初始化页面
      // 页面加载完成后初始化所有事件监听
      document.addEventListener('DOMContentLoaded', function () {
        // 初始化事件监听器
        initEventListeners()

        // 初始化页面
        const initPage = window.location.hash.replace('#', '') || 'home'
        setActivePage(initPage)
      })

      // 初始化所有事件监听器
      function initEventListeners() {
        // 1. 导航菜单点击事件
        setupNavigation()

        // 2. 标签模式切换事件
        setupTagModeToggle()

        // 3. 生成题目按钮点击事件
        setupQuestionGeneration()

        // 4. 查看全部题目按钮点击事件
        setupViewAllQuestions()

        // 5. 模型按钮点击事件
        setupModelSelection()

        // 6. 变形按钮点击事件
        setupTransformationControls()

        // ...其他监听...
        setupAuditControls()

        // 7. 浏览器历史记录变化事件
        window.addEventListener('popstate', function () {
          const hash = window.location.hash.replace('#', '') || 'home'
          setActivePage(hash)
        })
      }

      // 1. 导航菜单设置
      function setupNavigation() {
        document.querySelectorAll('.nav-item').forEach((item) => {
          item.addEventListener('click', function (e) {
            e.preventDefault()
            const targetPage = this.dataset.page
            handleNavigation(targetPage)
          })
        })
      }

      // 2. 标签模式切换设置
      function setupTagModeToggle() {
        document.querySelectorAll('input[name="tag-mode"]').forEach((radio) => {
          radio.addEventListener('change', function () {
            const isCustom = this.value === 'custom'
            document.getElementById('qtopic').style.display = isCustom
              ? 'none'
              : 'block'
            document.getElementById('custom-topic').style.display = isCustom
              ? 'block'
              : 'none'

            // 切换时清空另一个输入
            if (isCustom) {
              document.getElementById('qtopic').value = ''
            } else {
              document.getElementById('custom-topic').value = ''
            }
          })
        })
      }

      // 3. 生成题目设置
      function setupQuestionGeneration() {
        const generateBtn = document.getElementById('generateBtn')
        if (!generateBtn) return

        generateBtn.addEventListener('click', async function () {
          const btn = this
          const progress = document.getElementById('generate-progress')
          const container = document.getElementById('questions-container')
          const viewAllContainer = document.getElementById('view-all-container')
          const totalCountEl = document.getElementById('total-count')

          // 禁用按钮并显示加载状态
          btn.disabled = true
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...'
          progress.style.width = '0%'
          container.innerHTML =
            '<div class="example-card"><p>正在生成题目，请稍候...</p></div>'
          viewAllContainer.style.display = 'none'

          try {
            // 模拟进度条动画
            const progressInterval = setInterval(() => {
              const current = parseInt(progress.style.width) || 0
              progress.style.width = current + 10 + '%'
              if (current >= 90) clearInterval(progressInterval)
            }, 300)

            // 获取用户输入
            const requestData = getGenerationRequestData()

            // 调用API生成题目
            const response = await fetch('http://localhost:8000/generate', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(requestData),
              mode: 'cors',
            })

            clearInterval(progressInterval)
            progress.style.width = '100%'

            if (!response.ok) {
              throw new Error(`请求失败: ${response.status}`)
            }

            const data = await response.json()
            handleGenerationResponse(
              data,
              container,
              viewAllContainer,
              totalCountEl
            )
          } catch (error) {
            handleGenerationError(error, container)
            progress.style.width = '0%'
          } finally {
            btn.disabled = false
            btn.innerHTML = '<i class="fas fa-play"></i> 重新生成'
          }
        })
      }

      // 获取生成题目请求数据
      function getGenerationRequestData() {
        const selectedTypes = Array.from(
          document.querySelectorAll('input[name="qtype"]:checked')
        ).map((el) => el.value)
        const count = parseInt(document.getElementById('qcount').value)
        const difficulty = document.getElementById('qdifficulty').value
        const model = document.getElementById('qmodel').value

        // 获取主题（预设或自定义）
        const isCustomTopic =
          document.querySelector('input[name="tag-mode"]:checked').value ===
          'custom'
        let topic = ''
        if (isCustomTopic) {
          topic = document.getElementById('custom-topic').value.trim()
          if (!topic) {
            throw new Error('请输入自定义主题')
          }
        } else {
          topic = document.getElementById('qtopic').value
        }

        // 验证输入
        if (selectedTypes.length === 0) {
          throw new Error('请至少选择一种题目类型')
        }
        if (isNaN(count) || count < 5) {
          throw new Error('题目数量需大于5')
        }

        return {
          types: selectedTypes,
          count: count,
          difficulty: difficulty,
          topic: topic,
          is_custom_topic: isCustomTopic,
          model: model,
        }
      }

      // 处理生成题目响应
      function handleGenerationResponse(
        data,
        container,
        viewAllContainer,
        totalCountEl
      ) {
        if (
          data.status === 'success' &&
          data.questions &&
          data.questions.length > 0
        ) {
          // 存储全部题目
          window.allQuestions = data.questions

          // 只显示前3个题目
          const displayCount = Math.min(3, data.questions.length)
          const displayQuestions = data.questions.slice(0, displayCount)
          container.innerHTML = renderQuestions(displayQuestions)

          // 如果题目多于3个，显示"查看全部"按钮
          if (data.questions.length > 3) {
            viewAllContainer.style.display = 'block'
            totalCountEl.textContent = `共生成 ${data.questions.length} 道题目`
          }
        } else {
          throw new Error(data.message || '没有生成题目，请检查参数设置')
        }
      }

      // 处理生成题目错误
      function handleGenerationError(error, container) {
        console.error('生成题目出错:', error)
        container.innerHTML = `
    <div class="example-card" style="color: #ef4444;">
        <p><i class="fas fa-exclamation-triangle"></i> ${error.message}</p>
        ${
          error.message.includes('网络连接')
            ? '<p style="font-size:0.8rem">请检查后端服务是否运行 (http://localhost:8000)</p>'
            : ''
        }
    </div>`
      }

      // 4. 查看全部题目设置
      function setupViewAllQuestions() {
        const viewAllBtn = document.getElementById('viewAllBtn')
        if (!viewAllBtn) return

        viewAllBtn.addEventListener('click', function () {
          const container = document.getElementById('questions-container')
          if (window.allQuestions) {
            container.innerHTML = renderQuestions(window.allQuestions)
            document.getElementById('view-all-container').style.display = 'none'
          }
        })
      }

      // 5. 模型选择设置
      function setupModelSelection() {
        const modelButtons = document.querySelectorAll('.model-btn')
        const modelInput = document.getElementById('qmodel')

        modelButtons.forEach((btn) => {
          btn.addEventListener('click', () => {
            modelButtons.forEach((b) => b.classList.remove('active'))
            btn.classList.add('active')
            modelInput.value = btn.dataset.model
          })
        })
      }

      // 6. 题目变形设置
      function setupTransformationControls() {
        // 变形类型选择
        document.querySelectorAll('.transform-btn').forEach((btn) => {
          btn.addEventListener('click', function () {
            document
              .querySelectorAll('.transform-btn')
              .forEach((b) => b.classList.remove('active'))
            this.classList.add('active')
            updateTransformParamsUI(this.dataset.type)
          })
        })

        // 执行变形按钮
        const executeBtn = document.getElementById('execute-transform')
        if (executeBtn) {
          executeBtn.addEventListener('click', executeTransformation)
        }
      }

      // 执行题目变形
      async function executeTransformation() {
        const btn = this
        const resultsContainer = document.getElementById('results-container')

        // 检查是否有题目可变形
        if (!window.allQuestions || window.allQuestions.length === 0) {
          resultsContainer.innerHTML = `
            <div class="error">
                <i class="fas fa-exclamation-triangle"></i> 没有可用的题目进行变形，请先生成题目
            </div>
        `
          return
        }

        // 获取变形类型
        const activeBtn = document.querySelector('.transform-btn.active')
        if (!activeBtn) {
          resultsContainer.innerHTML = `
            <div class="error">
                <i class="fas fa-exclamation-triangle"></i> 请选择变形方式
            </div>
        `
          return
        }

        const transformType = activeBtn.dataset.type

        // 准备变形参数
        const params = {}
        if (transformType === 'restructure') {
          params.target_type = document.getElementById('target-type').value
        } else if (transformType === 'difficulty') {
          params.direction = document.getElementById(
            'difficulty-direction'
          ).value
        } else if (transformType === 'format') {
          params.target_format = document.getElementById('target-format').value
        } else if (transformType === 'translate') {
          params.target_lang = document.getElementById('target-lang').value
        }

        // 禁用按钮并显示加载状态
        btn.disabled = true
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...'
        resultsContainer.innerHTML =
          '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 正在变形题目，请稍候...</div>'

        try {
          // 调用API进行变形
          const response = await fetch('http://localhost:8000/transform', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              questions: window.allQuestions.slice(0, 5), // 只变形前5题
              operations: [
                {
                  type: transformType,
                  params: params,
                },
              ],
            }),
          })

          if (!response.ok) {
            throw new Error(`请求失败: ${response.status}`)
          }

          const data = await response.json()

          // 处理返回结果
          if (
            data.status === 'success' &&
            data.transformed_questions &&
            data.transformed_questions.length > 0
          ) {
            resultsContainer.innerHTML = renderTransformResults(
              data.transformed_questions
            )
          } else {
            resultsContainer.innerHTML =
              '<div class="empty">没有生成变形题目，请重试</div>'
          }
        } catch (error) {
          console.error('题目变形出错:', error)
          resultsContainer.innerHTML = `
            <div class="error">
                <i class="fas fa-exclamation-triangle"></i> ${error.message}
            </div>
        `
        } finally {
          btn.disabled = false
          btn.innerHTML = '<i class="fas fa-magic"></i> 执行变形'
        }
      }

      // 获取变形参数
      function getTransformationParams(transformType) {
        const params = {}
        switch (transformType) {
          case 'restructure':
            params.target_type = document.getElementById('target-type').value
            break
          case 'difficulty':
            params.direction = document.getElementById(
              'difficulty-direction'
            ).value
            break
          case 'format':
            params.target_format =
              document.getElementById('target-format').value
            break
          case 'translate':
            params.target_lang = document.getElementById('target-lang').value
            break
        }
        return params
      }

      // 更新变形参数UI
      function updateTransformParamsUI(transformType) {
        const paramsContainer = document.getElementById('transform-params')
        let paramsHTML = ''

        switch (transformType) {
          case 'restructure':
            paramsHTML = `
                <div class="param-group">
                    <label>目标题型</label>
                    <select id="target-type">
                        <option value="multiple_choice">选择题</option>
                        <option value="true_false">判断题</option>
                        <option value="short_answer">简答题</option>
                        <option value="fill_blank">填空题</option>
                    </select>
                </div>
            `
            break

          case 'difficulty':
            paramsHTML = `
                <div class="param-group">
                    <label>难度调整方向</label>
                    <select id="difficulty-direction">
                        <option value="easy">降低难度</option>
                        <option value="hard">提高难度</option>
                    </select>
                </div>
            `
            break

          case 'format':
            paramsHTML = `
                <div class="param-group">
                    <label>目标格式</label>
                    <select id="target-format">
                        <option value="markdown">Markdown</option>
                        <option value="latex">LaTeX</option>
                        <option value="plain">纯文本</option>
                    </select>
                </div>
            `
            break

          case 'translate':
            paramsHTML = `
                <div class="param-group">
                    <label>目标语言</label>
                    <select id="target-lang">
                        <option value="en">英文</option>
                        <option value="zh">中文</option>
                    </select>
                </div>
            `
            break

          default: // paraphrase不需要额外参数
            paramsHTML = `<p>将保持题目类型不变，仅进行同义替换</p>`
        }

        paramsContainer.innerHTML = paramsHTML
      }

      // 页面切换函数
      function setActivePage(pageId) {
        const pages = document.querySelectorAll('.content-page')
        const navItems = document.querySelectorAll('.nav-item')

        // 使用GSAP动画切换页面
        pages.forEach((page) => {
          if (page.id === pageId) {
            gsap.fromTo(
              page,
              { opacity: 0, y: 20, display: 'none' },
              {
                duration: 0.6,
                opacity: 1,
                y: 0,
                display: 'block',
                ease: 'power3.out',
              }
            )
          } else {
            gsap.to(page, {
              duration: 0.3,
              opacity: 0,
              y: 20,
              ease: 'power2.inOut',
              onComplete: () => (page.style.display = 'none'),
            })
          }
        })

        // 更新导航菜单激活状态
        navItems.forEach((nav) => {
          nav.classList.toggle('active', nav.dataset.page === pageId)
        })

        // 滚动到顶部
        window.scrollTo({ top: 0, behavior: 'smooth' })
      }

      // 导航处理函数
      function handleNavigation(targetPage) {
        setActivePage(targetPage)
        history.pushState({}, '', `#${targetPage}`)
      }

      // 渲染题目列表的函数
      function renderQuestions(questions) {
        return questions
          .map((q, i) => {
            let typeClass = '',
              typeText = ''
            switch (q.type) {
              case 'multiple_choice':
                typeClass = 'multiple-choice'
                typeText = '选择题'
                break
              case 'true_false':
                typeClass = 'true-false'
                typeText = '判断题'
                break
              case 'short_answer':
                typeClass = 'short-answer'
                typeText = '简答题'
                break
              case 'fill_blank':
                typeClass = 'fill-blank'
                typeText = '填空题'
                break
              default:
                typeText = q.type || '未知类型'
            }

            return `
        <div class="example-card">
            <div class="example-header">
                <span class="question-type ${typeClass}">${typeText}</span>
                ${
                  q.difficulty
                    ? `<span class="question-difficulty">${q.difficulty}</span>`
                    : ''
                }
                ${
                  q.topic
                    ? `<span class="question-topic">${q.topic}</span>`
                    : ''
                }
            </div>
            <p class="question-content">${i + 1}. ${q.question}</p>
            ${
              q.options
                ? `
            <div class="question-options">
                ${Object.entries(q.options)
                  .map(([key, val]) => `<p>${key}. ${val}</p>`)
                  .join('')}
            </div>`
                : ''
            }
            ${
              q.answer ? `<p class="question-answer">答案: ${q.answer}</p>` : ''
            }
            ${
              q.explanation
                ? `<p class="question-explanation">解析: ${q.explanation}</p>`
                : ''
            }
        </div>`
          })
          .join('')
      }

      // 渲染变形结果的函数
      function renderTransformResults(transformations) {
        const operationNames = {
          paraphrase: '同义替换',
          restructure: '结构调整',
          difficulty: '难度调整',
          format: '格式转换',
          translate: '语言翻译',
        }

        return transformations
          .map((t, i) => {
            return `
        <div class="result-card">
            <div class="result-header">
                <span class="transform-type">${
                  operationNames[t.operation] || t.operation
                }</span>
            </div>

            <div class="transform-container">
                <div class="transform-before">
                    <h4>变形前</h4>
                    ${renderQuestionPreview(t.original)}
                </div>
                <i class="fas fa-arrow-right transform-arrow"></i>
                <div class="transform-after">
                    <h4>变形后</h4>
                    ${renderQuestionPreview(t.transformed)}
                </div>
            </div>
        </div>
        `
          })
          .join('')
      }

      // 渲染题目预览
      function renderQuestionPreview(question) {
        let typeClass = '',
          typeText = ''
        switch (question.type) {
          case 'multiple_choice':
            typeClass = 'multiple-choice'
            typeText = '选择题'
            break
          case 'true_false':
            typeClass = 'true-false'
            typeText = '判断题'
            break
          case 'short_answer':
            typeClass = 'short-answer'
            typeText = '简答题'
            break
          case 'fill_blank':
            typeClass = 'fill-blank'
            typeText = '填空题'
            break
          default:
            typeText = question.type || '未知类型'
        }

        return `
    <div class="question-preview">
        <div class="preview-header">
            <span class="question-type ${typeClass}">${typeText}</span>
            ${
              question.difficulty
                ? `<span class="question-difficulty">${question.difficulty}</span>`
                : ''
            }
        </div>
        <p class="question-content">${question.question}</p>
        ${
          question.options
            ? `
        <div class="question-options">
            ${Object.entries(question.options)
              .map(
                ([key, val]) =>
                  `<div class="option"><span>${key}.</span> ${val}</div>`
              )
              .join('')}
        </div>`
            : ''
        }
        ${
          question.answer
            ? `<div class="answer">答案: ${question.answer}</div>`
            : ''
        }
    </div>`
      }

      // 设置审核控制
      function setupAuditControls() {
        // 审核模式选择
        document
          .querySelectorAll('.btn-group-grid .form-btn')
          .forEach((btn) => {
            btn.addEventListener('click', function () {
              document
                .querySelectorAll('.btn-group-grid .form-btn')
                .forEach((b) => b.classList.remove('active'))
              this.classList.add('active')
            })
          })

        // 审核按钮点击事件
        document
          .getElementById('runAuditBtn')
          .addEventListener('click', async function () {
            const btn = this
            btn.disabled = true
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 审核中...'

            try {
              const mode = document.querySelector(
                '.btn-group-grid .form-btn.active'
              ).dataset.mode

              const response = await fetch('http://localhost:8000/audit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode }),
              })

              if (!response.ok) throw new Error(await response.text())

              const report = await response.json()
              updateAuditUI(report)
            } catch (error) {
              console.error('审核失败:', error)
              alert(`审核失败: ${error.message}`)
            } finally {
              btn.disabled = false
              btn.innerHTML = '<i class="fas fa-search"></i> 重新审核'
            }
          })
      }

      // 更新审核结果界面
      function updateAuditUI(report) {
        // 创建指标卡片
        const metrics = [
          {
            id: 'success-rate',
            label: '成功率',
            value: `${(report.performance.success_rate * 100).toFixed(1)}%`,
          },
          {
            id: 'avg-response',
            label: '平均响应',
            value: `${report.performance.average_response_time || 0}ms`,
          },
          {
            id: 'qps',
            label: 'QPS',
            value: report.performance.questions_per_second || 'N/A',
          },
          {
            id: 'max-cpu',
            label: 'CPU峰值',
            value: `${report.resources.max_cpu || 0}%`,
          },
          {
            id: 'max-memory',
            label: '内存峰值',
            value: `${report.resources.max_memory || 0}%`,
          },
          {
            id: 'composite-score',
            label: '综合评分',
            value: report.composite_score || 'N/A',
          },
        ]

        // 渲染指标卡片
        const summaryContainer = document.getElementById('audit-summary')
        summaryContainer.innerHTML = metrics
          .map(
            (metric) => `
        <div class="metric-card">
            <div class="metric-value">${metric.value}</div>
            <div class="metric-label">${metric.label}</div>
        </div>
    `
          )
          .join('')
        summaryContainer.style.display = 'grid'

        // 渲染风险表格
        const tbody = document.getElementById('risk-tbody')
        tbody.innerHTML = (report.safety_issues || [])
          .map(
            (issue) => `
        <tr>
            <td>${issue.question || ''}</td>
            <td>${issue.category || '未知'}</td>
            <td>${issue.reason || ''}</td>
            <td>${issue.level || 'medium'}</td>
        </tr>
    `
          )
          .join('')

        // 显示风险表格
        document.getElementById('risk-table-section').style.display = report
          .safety_issues?.length
          ? 'block'
          : 'none'
      }

      //下载报告
      document
        .getElementById('loadReportBtn')
        .addEventListener('click', async function () {
          const btn = this
          btn.disabled = true
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加载中...'

          try {
            // 检查报告是否存在
            const checkResponse = await fetch(
              'http://localhost:8000/get_report'
            )
            if (!checkResponse.ok) {
              throw new Error('报告未生成，请先运行审核')
            }

            // 直接触发下载
            const downloadUrl = 'http://localhost:8000/download_report'
            const a = document.createElement('a')
            a.href = downloadUrl
            a.download = 'model_test_report.md'
            document.body.appendChild(a)
            a.click()
            document.body.removeChild(a)
          } catch (error) {
            alert(error.message)
          } finally {
            btn.disabled = false
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> 加载分析报告'
          }
        })
    </script>
  </body>
</html>
